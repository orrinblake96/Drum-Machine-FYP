<html>
<head>
  <meta charset="utf-8">
  <script src="./js/three.js"></script>
  <script src="./js/leap-0.6.4.js"></script>
  <script src="js/leap-plugins-0.1.11pre.js"></script>
  <script src="../build/leap-widgets-0.1.0.js"></script>
  <script src="js/OrbitControls.js"></script>
  <!-- <script src="./js/buttonCreation.js"></script> -->

  <style>
    body {
      margin: 0;
    }
    canvas.leap-boneHand{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

  </style>

</head>
<body>
</body>

<script>
'use strict';
  // Set up plugins

  Leap.loop({

    hand: function(hand){

      let indexF = hand.indexFinger.direction;
      let oscillatorGainNode = context.createGain();
      let distortionGainNode = context.createGain();
      let distortionNode = context.createWaveShaper();

      function playSineWave(tone, distortionAmount) {
        let oscillator = context.createOscillator();
        distortionNode.curve = makeDistortionCurve(distortionAmount);

        oscillator.type = 'sine';
        tone > 100 ? oscillator.frequency.value = tone : oscillator.frequency.value = 0;
        oscillator.connect(oscillatorGainNode);
        oscillatorGainNode.connect(distortionGainNode);
        distortionGainNode.connect(distortionNode);
        oscillator.connect(distortionNode);
        oscillator.connect(context.destination);
        oscillator.start();
        oscillator.stop(context.currentTime + 0.6);
      }

      function makeDistortionCurve( amount ) {
        var k = typeof amount === 'number' ? amount : 0,
          n_samples = 44100,
          curve = new Float32Array(n_samples),
          deg = Math.PI / 180,
          i = 0,
          x;
        for ( ; i < n_samples; ++i ) {
          x = i * 2 / n_samples - 1;
          curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
      };

      playSineWave((indexF[0]) * 1000, (indexF[1]) * 2000);
    }

  })
    .use('transform', {
      vr: 'desktop' // Switch to meters.
    })
    .use('boneHand', {
      targetEl: document.body,
      jointColor: new THREE.Color(0xffffff),
      rendererOps: {antialias: true}
    })
    .use('handEntry')
    .on('handFound', function (hand){
      {console.log( 'hand found', hand ); }
    })
    .on('handLost', function (hand){
      {console.log( 'hand lost', hand ); }
    })
    .use('screenPosition', {positioning: 'absolute'});


  // Set up scene
  var scene = Leap.loopController.plugins.boneHand.scene;
  var camera = Leap.loopController.plugins.boneHand.camera;
  var renderer = Leap.loopController.plugins.boneHand.renderer;

  camera.position.set( -0.034, 0.45, 0.50 );

  // var controls = new THREE.OrbitControls( camera );


  // Add a plane
  var planeGeo = new THREE.PlaneGeometry(0.1, 0.2);
  var material = new THREE.MeshPhongMaterial({side: THREE.DoubleSide});
  var buttonMesh = new THREE.Mesh(planeGeo, material);
  buttonMesh.material.color.setHex(0x222222);

  buttonMesh.name = "drum button";

//create buffer for sound & setup web Audio (|| allows use on safari in the case web audio isn't available)
var drumBuffer = null;
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();

//all sounds are loaded here, create a 'GET' request to a set URL(maybe user input in the future)
function loadSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';

  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      drumBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

//Takes a buffer, sets that equal to the source, then connects source to destination (speakers, earphones, ... etc)
//Add extra filters/synth sounds here. Then connect each filter to the destination
function playSound(buffer) {
  var source = context.createBufferSource();
  source.buffer = buffer;
  var dist = context.createWaveShaper();
  dist.curve = makeDistortionCurve(90);
  source.connect(dist);
  dist.connect(context.destination);
  source.connect(context.destination);
  source.loop = true;
  source.start(0);
}

//Distortion function, dont change for now(put in seperate function)
function makeDistortionCurve( amount ) {
  var k = typeof amount === 'number' ? amount : 0,
    n_samples = 44100,
    curve = new Float32Array(n_samples),
    deg = Math.PI / 180,
    i = 0,
    x;
  for ( ; i < n_samples; ++i ) {
    x = i * 2 / n_samples - 1;
    curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
  }
  return curve;
};

// Coloumn 1 buttons:
// *********************************************************************
createRoundButton('button1-1', -0.25, 0.4, -0.05, 0xccccff, 0x222222, './drumButtonSounds/rapMumble.wav');
createRoundButton('button1-2', -0.25, 0.325, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/clap.wav');
createRoundButton('button1-2', -0.25, 0.25, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/drumBeat2.wav');

createRoundButton('button2-1', -0.175, 0.4, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/buttonBeat.wav');
createRoundButton('button2-2', -0.175, 0.325, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/percussionLow.wav');
createRoundButton('button2-2', -0.175, 0.25, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/rapBeat2.wav');

createRoundButton('button3-1', -0.10, 0.4, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/mumbleRapBeat.wav');
createRoundButton('button3-2', -0.10, 0.325, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/slowBeat.wav');
createRoundButton('button3-2', -0.10, 0.25, -0.05, 0xccccff, 0x222222,'./drumButtonSounds/tinCanBeat.wav');

// //sliders
// createSlider('Distortion', 0, 0.247, -0.05, true, false, false);

// function createSlider(name, x, y, z, xaxis, yaxis, zaxis, soundUrl){
//   var planeGeo = new THREE.PlaneGeometry(0.1, 0.2);
//   var planeMesh = new THREE.Mesh(planeGeo, material);
//   planeMesh.material.color.setHex(0x222222);
//   planeMesh.scale.set(0.5, 0.5, 0.5);
//   planeMesh.name = name;
//   var longThrow = 0.05;
//   planeMesh.position.set(x, y, z);
//   scene.add(planeMesh);
//   new InteractablePlane(planeMesh, Leap.loopController, {moveX: xaxis, moveY: yaxis, moveZ: zaxis});
// }

function createRoundButton(name, x, y, z, colourPressed, colourReleased, loadUrl){
  loadSound(loadUrl);
  let circleGeo = new THREE.CircleGeometry(0.035, 100);
  buttonMesh = new THREE.Mesh(circleGeo, material.clone());
  buttonMesh.name = name;

  buttonMesh.position.set(x, y, z);
  scene.add(buttonMesh);

  let roundButton = new PushButton(
    new InteractablePlane(buttonMesh, Leap.loopController, {moveX: false, moveY: false})
  ).on('press', function(mesh){

    playSound(drumBuffer);
    mesh.material.color.setHex(colourPressed);

  }).on('release', function(mesh){
    
    mesh.material.color.setHex(colourReleased);

  });
}

</script>

</html>
