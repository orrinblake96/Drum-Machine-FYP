<html>
<head>
  <meta charset="utf-8">
  <script src="./js/three.js"></script>
  <script src="./js/leap-0.6.4.js"></script>
  <script src="js/leap-plugins-0.1.11pre.js"></script>
  <script src="../build/leap-widgets-0.1.0.js"></script>
  <script src="js/OrbitControls.js"></script>
  <!-- <script src="./js/buttonCreation.js"></script> -->

  <style>
    body {
      margin: 0;
    }
    canvas.leap-boneHand{
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

  </style>

</head>
<body>
</body>

<script>
'use strict';
  // Set up plugins

  Leap.loop({

    hand: function(hand){

      if (hand.type === "right") {

      let indexF = hand.indexFinger.direction;
      // console.log(Math.abs((indexF[0]) * 1000), (indexF[1]) * 3000);
      let oscillatorGainNode = context.createGain();
      let distortionGainNode = context.createGain();
      let distortionNode = context.createWaveShaper();

      function playSineWave(tone, distortionAmount) {
        let oscillator = context.createOscillator();
        distortionNode.curve = makeDistortionCurve(distortionAmount);

        oscillator.type = 'sine';
        tone > 100 && distortionAmount > 100 ? oscillator.frequency.value = tone : oscillator.frequency.value = 0;
        oscillator.connect(oscillatorGainNode);
        oscillatorGainNode.connect(distortionGainNode);
        distortionGainNode.connect(distortionNode);
        oscillator.connect(distortionNode);
        oscillator.connect(context.destination);
        oscillator.start();
        oscillator.stop(context.currentTime + 0.6);
      }

      function makeDistortionCurve( amount ) {
        var k = typeof amount === 'number' ? amount : 0,
          n_samples = 44100,
          curve = new Float32Array(n_samples),
          deg = Math.PI / 180,
          i = 0,
          x;
        for ( ; i < n_samples; ++i ) {
          x = i * 2 / n_samples - 1;
          curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
        }
        return curve;
      };

      playSineWave(Math.abs((indexF[0]) * 1000), (indexF[1]) * 2000);
    }
  }

  })
    .use('transform', {
      vr: 'desktop' // Switch to meters.
    })
    .use('boneHand', {
      targetEl: document.body,
      jointColor: new THREE.Color(0xffffff),
      rendererOps: {antialias: true}
    })
    .use('screenPosition', {positioning: 'absolute'});

  // Set up scene
  var scene = Leap.loopController.plugins.boneHand.scene;
  var camera = Leap.loopController.plugins.boneHand.camera;
  var renderer = Leap.loopController.plugins.boneHand.renderer;
  var sources = [];

  camera.position.set( -0.034, 0.45, 0.50 );


//create buffer for sound & setup web Audio (|| allows use on safari in the case web audio isn't available)
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();

//all sounds are loaded here, create a 'GET' request to a set URL(maybe user input in the future)
var mumbleBuffer = null;
function loadMumbleSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      mumbleBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var clapBuffer = null;
function loadClapSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      clapBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var buttonBeatBuffer = null;
function loadButtonBeatSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      buttonBeatBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var drumBeat2Buffer = null;
function loadDrumBeat2Sound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      drumBeat2Buffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var percussionLowBuffer = null;
function loadpercussionLowSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      percussionLowBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var rapBeat2Buffer = null;
function loadrapBeat2Sound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      rapBeat2Buffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var mumbleRapBeatBuffer = null;
function loadMumbleRapBeatSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      mumbleRapBeatBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var slowBeatBuffer = null;
function loadSlowBeatSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      slowBeatBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var tinCanBuffer = null;
function loadtinCanSound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      tinCanBuffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

var drumBeat2Buffer = null;
function loadDrumBeat2Sound(url) {
  var request = new XMLHttpRequest();
  request.open('GET', url, true);
  request.responseType = 'arraybuffer';
  // Decode asynchronously, can also decode outise of load function
  request.onload = function() {
    context.decodeAudioData(request.response, function(buffer) {
      drumBeat2Buffer = buffer;
    });
  }
  //sends request for play function to use
  request.send();
}

//Takes a buffer, sets that equal to the source, then connects source to destination (speakers, earphones, ... etc)
//Add extra filters/synth sounds here. Then connect each filter to the destination
function playSound(buffer, play) {
  var audio = context.createBufferSource();
  audio.buffer = buffer;
  var dist = context.createWaveShaper();
  dist.curve = makeDistortionCurve(90);
  audio.connect(dist);
  dist.connect(context.destination);
  audio.connect(context.destination);
  // audio.loop = play;
  audio.start(0);
}

function stopSound() {
  context.close();
  context = new AudioContext();
}

let circleGeo = new THREE.CircleGeometry(0.035, 100);
var material = new THREE.MeshPhongMaterial();

let buttonMesh1_1 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh1_1.name = 'button1-1';
buttonMesh1_1.material.color.setHex(0x222222);
buttonMesh1_1.position.set(-0.25, 0.4, -0.05);
scene.add(buttonMesh1_1);
loadMumbleSound('./drumButtonSounds/rapMumble.wav');
let roundButton = new PushButton(
  new InteractablePlane(buttonMesh1_1, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(mumbleBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

var buttonMesh1_2 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh1_2.name = 'button1-2';
buttonMesh1_2.material.color.setHex(0x222222);
buttonMesh1_2.position.set(-0.25, 0.325, -0.05);
scene.add(buttonMesh1_2);
loadClapSound('./drumButtonSounds/clap.wav');
let roundButton1_2 = new PushButton(
  new InteractablePlane(buttonMesh1_2, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(clapBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh1_3 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh1_3.name = 'button1-3';
buttonMesh1_3.material.color.setHex(0x222222);
buttonMesh1_3.position.set(-0.25, 0.25, -0.05);
scene.add(buttonMesh1_3);
loadDrumBeat2Sound('./drumButtonSounds/drumBeat2.wav');
let roundButton1_3 = new PushButton(
  new InteractablePlane(buttonMesh1_3, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(drumBeat2Buffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh2_1 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh2_1.name = 'button2-1';
buttonMesh2_1.material.color.setHex(0x222222);
buttonMesh2_1.position.set(-0.175, 0.4, -0.05);
scene.add(buttonMesh2_1);
loadpercussionLowSound('./drumButtonSounds/percussionLow.wav');
let roundButton2_1 = new PushButton(
  new InteractablePlane(buttonMesh2_1, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(percussionLowBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh2_2 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh2_2.name = 'button2-2';
buttonMesh2_2.material.color.setHex(0x222222);
buttonMesh2_2.position.set(-0.175, 0.325, -0.05);
scene.add(buttonMesh2_2);
loadrapBeat2Sound('./drumButtonSounds/rapBeat2.wav');
let roundButton2_2 = new PushButton(
  new InteractablePlane(buttonMesh2_2, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(rapBeat2Buffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh2_3 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh2_3.name = 'button2-3';
buttonMesh2_3.material.color.setHex(0x222222);
buttonMesh2_3.position.set(-0.175, 0.25, -0.05);
scene.add(buttonMesh2_3);
loadMumbleRapBeatSound('./drumButtonSounds/mumbleRapBeat.wav');
let roundButton2_3 = new PushButton(
  new InteractablePlane(buttonMesh2_3, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(mumbleRapBeatBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh3_1 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh3_1.name = 'button3-1';
buttonMesh3_1.material.color.setHex(0x222222);
buttonMesh3_1.position.set(-0.10, 0.4, -0.05);
scene.add(buttonMesh3_1);
loadSlowBeatSound('./drumButtonSounds/slowBeat.wav');
let roundButton3_1 = new PushButton(
  new InteractablePlane(buttonMesh3_1, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(slowBeatBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh3_2 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh3_2.name = 'button3-1';
buttonMesh3_2.material.color.setHex(0x222222);
buttonMesh3_2.position.set(-0.10, 0.325, -0.05);
scene.add(buttonMesh3_2);
loadtinCanSound('./drumButtonSounds/tinCanBeat.wav');
let roundButton3_2 = new PushButton(
  new InteractablePlane(buttonMesh3_2, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(tinCanBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

let buttonMesh3_3 = new THREE.Mesh(circleGeo, material.clone());
buttonMesh3_3.name = 'button3-1';
buttonMesh3_3.material.color.setHex(0x222222);
buttonMesh3_3.position.set(-0.10, 0.25, -0.05);
scene.add(buttonMesh3_3);
loadButtonBeatSound('./drumButtonSounds/buttonBeat.wav');
let roundButton3_3 = new PushButton(
  new InteractablePlane(buttonMesh3_3, Leap.loopController, {moveX: false, moveY: false})
).on('press', function(mesh){
  playSound(buttonBeatBuffer, true);
  mesh.material.color.setHex(0xccccff);
}).on('release', function(mesh){
  stopSound();
  mesh.material.color.setHex(0x222222);
});

//Distortion function, dont change for now(put in seperate function)
function makeDistortionCurve( amount ) {
  var k = typeof amount === 'number' ? amount : 0,
    n_samples = 44100,
    curve = new Float32Array(n_samples),
    deg = Math.PI / 180,
    i = 0,
    x;
  for ( ; i < n_samples; ++i ) {
    x = i * 2 / n_samples - 1;
    curve[i] = ( 3 + k ) * x * 20 * deg / ( Math.PI + k * Math.abs(x) );
  }
  return curve;
};

</script>

</html>
